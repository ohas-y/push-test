<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>体調記録システム 登録ページ</title>
</head>
<body>
  <h1>体調記録システム 登録</h1>

<br><br>
  <p>以下の文章をお読みいただき、同意いただけましたらメールアドレスを登録してください</p> 
  
  <!-- 利用規約 -->
  <section id="terms">
    <h2>利用規約</h2>
    <p>
      第1条（サービス内容）<br>
      本サービスは、利用者が毎日の体調データを記録し、管理するためのBOTサービスです。<br><br>

      第2条（アカウント利用）<br>
      登録されたアカウントは、利用者自身の記録管理のみに使用します。
      これ以外の目的（広告配信、第三者提供など）には使用しません。<br><br>

      第3条（禁止事項）<br>
      以下の行為を禁止します。<br>
      - 不正アクセスや他の利用者への迷惑行為<br>
      - 本サービスの運営を妨げる行為<br><br>

      第4条（免責事項）<br>
      本サービスの利用によって生じたいかなる損害についても、当方は責任を負いません。
      記録内容の正確性や健康上の判断は、利用者ご自身の責任で行ってください。<br><br>

      第5条（規約変更）<br>
      本規約は必要に応じて変更される場合があります。変更後の規約は公開時点から効力を持ちます。
    </p>

    <h2>プライバシーポリシー</h2>
    <p>
      第1条（収集する情報）<br>
      - 利用者が入力した体調や気分の記録<br>
      - アカウント情報（メールアドレス等）<br><br>

      第2条（利用目的）<br>
      収集した情報は、利用者自身の体調管理をサポートする目的でのみ使用します。<br><br>

      第3条（第三者提供）<br>
      収集した情報は、法令に基づく場合を除き、第三者に提供することはありません。<br><br>

      第4条（情報管理）<br>
      個人情報および記録データは、安全に管理します。<br><br>

      第5条（利用者の権利）<br>
      利用者は、自身の登録情報の確認・修正・削除をいつでも行うことができます。
    </p>

    <button id="agreeButton"style="padding: 10px 20px; font-size: 12px; margin-top: 10px;">同意して登録へ</button>
  </section>

 <!-- メール登録 -->
<section id="register" style="display:none;">
  <h2>メールアドレス登録</h2>
<br>  <p>※Gmail以外のメールアドレスは登録できません。</p> 
  
  <input type="email" id="email" placeholder="メールアドレスを入力" required
         style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
  <button id="registerButton" style="padding: 10px 20px; font-size: 12px; margin-top: 10px;">
    登録する
  </button>
</section>

  <!-- 通知許可 -->
  <section id="notify" style="display:none;">
    <h2>Push通知設定</h2>
    <button id="subscribe">通知を許可する</button>
  </section>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx0A19Kd9Qg6In_Te5rotz32D-cvJa_96kbphWHuZSgQD6i-U8ZNVseQi1eNRWfnRQagA/exec";

    // 利用規約同意 → メール登録表示
    document.getElementById('agreeButton').addEventListener('click', () => {
      document.getElementById('terms').style.display = 'none';
      document.getElementById('register').style.display = 'block';
    });

    // メール登録
    document.getElementById('registerButton').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) { alert('メールを入力してください'); return; }
 
      // 🔹 Gmailチェック（フロント側）
      if (!email.endsWith("@gmail.com")) {
        alert("Gmail以外は登録できません");
        return;
      }
      
      alert('次に通知を許可してください');
      document.getElementById('register').style.display = 'none';
      document.getElementById('notify').style.display = 'block';
    });

    // 通知許可
    document.getElementById('subscribe').addEventListener('click', async () => {
      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.register('sw.js');
        console.log('SW登録完了', registration);
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: 'BARXhF6BM5j_pIHropz3a5EmDtvky8coOsYew0ayRwvNWeJXcf7ffO2jg4KhLezF6ii21W-P_xiC7tybB7J0CQw'
        });


    const emailValue = document.getElementById('email').value.trim();

    // ★ ここで送信データをログ出力
    console.log("送信予定データ:", { 
      email: emailValue, 
      subscription: subscription 
    });
        
        // GASに登録
await fetch(GAS_URL, {
  method: 'POST',
  mode: 'cors',  // ← ここを追加
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ email: document.getElementById('email').value.trim(), subscription })
});


        alert('登録完了！1日3回通知が届きます');
        document.getElementById('notify').style.display = 'none';
      } else {
        alert('このブラウザはService Workerに対応していません。');
      }
    });
  </script>
</body>
</html>
